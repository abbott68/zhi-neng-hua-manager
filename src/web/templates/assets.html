{% extends "base.html" %}

{% block title %}资产管理 - 运维平台{% endblock %}

{% block styles %}
<style>
    .asset-card {
        height: 100%;
        transition: transform 0.3s ease;
    }
    
    .asset-card:hover {
        transform: translateY(-5px);
    }
    
    .asset-icon {
        font-size: 2rem;
        margin-bottom: 1rem;
    }
    
    .asset-status {
        position: absolute;
        top: 1rem;
        right: 1rem;
    }
    
    .asset-info {
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.7);
    }
    
    .asset-info i {
        width: 20px;
        text-align: center;
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">资产列表</h4>
            {% if current_user.has_permission('manage_assets') %}
            <div>
                <button class="btn btn-secondary me-2" data-bs-toggle="modal" data-bs-target="#scanProgressModal">
                    <i class='bx bx-scan'></i> 扫描资产
                </button>
                <a href="/api/assets/export" class="btn btn-secondary me-2">
                    <i class='bx bx-export'></i> 导出
                </a>
                <button class="btn btn-secondary me-2" onclick="document.getElementById('importFile').click()">
                    <i class='bx bx-import'></i> 导入
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newAssetModal">
                    <i class='bx bx-plus'></i> 添加资产
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    {% for asset in assets %}
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="dashboard-card asset-card" data-asset-id="{{ asset.id }}">
            <span class="asset-status">
                <span class="badge bg-{{ 
                    'success' if asset.status == 'online' 
                    else 'danger' if asset.status == 'offline'
                    else 'warning' 
                }}">
                    {{ {
                        'online': '在线',
                        'offline': '离线',
                        'maintenance': '维护中'
                    }.get(asset.status, asset.status) }}
                </span>
            </span>
            <div class="text-center mb-3">
                <i class='bx 
                    {% if asset.type == 'server' %}bx-server
                    {% elif asset.type == 'database' %}bx-data
                    {% elif asset.type == 'application' %}bx-code-alt
                    {% else %}bx-cube{% endif %} 
                    asset-icon'></i>
                <h5 class="asset-name mb-0">{{ asset.name }}</h5>
                <small class="text-muted asset-type">{{ asset.type }}</small>
            </div>
            <div class="asset-info">
                <div class="mb-2">
                    <i class='bx bx-network-chart'></i>IP: {{ asset.ip_address }}
                </div>
                {% if asset.os_type %}
                <div class="mb-2">
                    <i class='bx bx-windows'></i>系统: {{ asset.os_type }} {{ asset.os_version }}
                </div>
                {% endif %}
                {% if asset.cpu_cores %}
                <div class="mb-2">
                    <i class='bx bx-chip'></i>CPU: {{ asset.cpu_cores }} 核
                </div>
                {% endif %}
                {% if asset.memory_size %}
                <div class="mb-2">
                    <i class='bx bx-memory-card'></i>内存: {{ asset.memory_size }} GB
                </div>
                {% endif %}
                {% if asset.disk_size %}
                <div class="mb-2">
                    <i class='bx bx-hdd'></i>磁盘: {{ asset.disk_size }} GB
                </div>
                {% endif %}
                {% if asset.description %}
                <div class="mt-3">
                    <i class='bx bx-info-circle'></i>{{ asset.description }}
                </div>
                {% endif %}
            </div>
            <hr class="border-secondary">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">更新于: {{ asset.updated_at.strftime('%Y-%m-%d %H:%M') }}</small>
                <div class="btn-group">
                    {% if current_user.has_permission('manage_assets') %}
                    <button class="btn btn-sm btn-info" onclick="checkAsset({{ asset.id }})">
                        <i class='bx bx-analyse'></i>
                    </button>
                    <button class="btn btn-sm btn-info" onclick="editAsset({{ asset.id }})">
                        <i class='bx bx-edit'></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteAsset({{ asset.id }})">
                        <i class='bx bx-trash'></i>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- 新建资产模态框 -->
<div class="modal fade" id="newAssetModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">添加资产</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assetForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">主机名</label>
                            <input type="text" class="form-control bg-dark text-light" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">IP地址</label>
                            <input type="text" class="form-control bg-dark text-light" name="ip_address" 
                                   placeholder="例如：192.168.1.1" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">资产类型</label>
                            <select class="form-select bg-dark text-light" name="type" required>
                                <option value="server">服务器</option>
                                <option value="database">数据库</option>
                                <option value="application">应用服务</option>
                                <option value="network">网络设备</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">状态</label>
                            <select class="form-select bg-dark text-light" name="status" required>
                                <option value="online">在线</option>
                                <option value="offline">离线</option>
                                <option value="maintenance">维护中</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">操作系统</label>
                            <input type="text" class="form-control bg-dark text-light" name="os_type">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">系统版本</label>
                            <input type="text" class="form-control bg-dark text-light" name="os_version">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CPU核心数</label>
                            <input type="number" class="form-control bg-dark text-light" name="cpu_cores">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">内存大小(GB)</label>
                            <input type="number" class="form-control bg-dark text-light" name="memory_size">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">磁盘大小(GB)</label>
                            <input type="number" class="form-control bg-dark text-light" name="disk_size">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">描述信息</label>
                            <textarea class="form-control bg-dark text-light" name="description" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveAsset()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加文件上传输入框 -->
<input type="file" id="importFile" accept=".csv" style="display: none" onchange="importAssets(this)">

<!-- 扫描资产模态框 -->
<div class="modal fade" id="scanProgressModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">资产扫描</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 扫描配置 -->
                <div id="scanConfig">
                    <div class="mb-4">
                        <h6>扫描范围</h6>
                        <div id="networkRanges">
                            <div class="network-range mb-2">
                                <div class="input-group">
                                    <input type="text" class="form-control bg-dark text-light" 
                                           placeholder="例如：192.168.1.0/24">
                                    <button class="btn btn-outline-danger" type="button" onclick="removeNetworkRange(this)">
                                        <i class='bx bx-trash'></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm mt-2" onclick="addNetworkRange()">
                            <i class='bx bx-plus'></i> 添加网段
                        </button>
                    </div>

                    <div class="mb-4">
                        <h6>扫描选项</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="detectOS" checked>
                                    <label class="form-check-label" for="detectOS">
                                        检测操作系统
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="scanPorts" checked>
                                    <label class="form-check-label" for="scanPorts">
                                        扫描端口
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h6>服务检测</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="checkSSH" checked>
                                    <label class="form-check-label" for="checkSSH">SSH</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="checkHTTP" checked>
                                    <label class="form-check-label" for="checkHTTP">HTTP/HTTPS</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="checkMySQL" checked>
                                    <label class="form-check-label" for="checkMySQL">MySQL</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="checkRedis" checked>
                                    <label class="form-check-label" for="checkRedis">Redis</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="checkMongoDB" checked>
                                    <label class="form-check-label" for="checkMongoDB">MongoDB</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="checkFTP" checked>
                                    <label class="form-check-label" for="checkFTP">FTP</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button class="btn btn-primary" onclick="startScan()">开始扫描</button>
                    </div>
                </div>

                <!-- 扫描进度和结果 -->
                <div id="scanProgress" style="display: none;">
                    <!-- 总体进度 -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span>总体进度</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress mb-2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="currentOperation">准备开始扫描...</small>
                    </div>

                    <!-- 实时日志 -->
                    <div class="mb-4">
                        <h6 class="d-flex justify-content-between align-items-center">
                            <span>扫描日志</span>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="toggleAutoScroll()">
                                    <i class='bx bx-scroll'></i>
                                    <span id="autoScrollText">自动滚动: 开</span>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                                    <i class='bx bx-trash'></i> 清空
                                </button>
                            </div>
                        </h6>
                        <div id="scanLogs" class="bg-darker p-3 rounded" style="height: 200px; overflow-y: auto; font-family: monospace;">
                        </div>
                    </div>

                    <!-- 扫描统计 -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="dashboard-card text-center">
                                <h3 id="totalHosts">0</h3>
                                <small class="text-muted">总主机数</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-card text-center">
                                <h3 id="scannedHosts">0</h3>
                                <small class="text-muted">已扫描</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-card text-center">
                                <h3 id="onlineHosts">0</h3>
                                <small class="text-muted">在线主机</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-card text-center">
                                <h3 id="servicesFound">0</h3>
                                <small class="text-muted">发现服务</small>
                            </div>
                        </div>
                    </div>

                    <!-- 发现的资产 -->
                    <div id="foundAssetsSection">
                        <h6 class="d-flex justify-content-between align-items-center">
                            <span>发现的资产 <span id="assetCount" class="badge bg-primary">0</span></span>
                            <div>
                                <button class="btn btn-sm btn-outline-success" onclick="addAllAssets()">
                                    <i class='bx bx-plus'></i> 全部添加
                                </button>
                            </div>
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>IP地址</th>
                                        <th>主机名</th>
                                        <th>设备类型</th>
                                        <th>操作系统</th>
                                        <th>开放端口</th>
                                        <th>发现服务</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="foundAssetsList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cancelScan()">取消</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加检测结果模态框 -->
<div class="modal fade" id="checkResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">检测结果</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="checkResult"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function editAsset(assetId) {
        // 获取当前资产数据
        const card = document.querySelector(`[data-asset-id="${assetId}"]`);
        const form = document.getElementById('newAssetForm');
        
        // 填充表单
        form.querySelector('[name="name"]').value = card.querySelector('.asset-name').textContent.trim();
        form.querySelector('[name="type"]').value = card.querySelector('.asset-type').textContent.trim();
        
        // 获取其他字段
        const info = card.querySelector('.asset-info');
        form.querySelector('[name="ip_address"]').value = info.textContent.match(/IP: ([\d.]+)/)?.[1] || '';
        form.querySelector('[name="os_type"]').value = info.textContent.match(/系统: (\w+)/)?.[1] || '';
        form.querySelector('[name="os_version"]').value = info.textContent.match(/系统: \w+ (.+)/)?.[1] || '';
        form.querySelector('[name="cpu_cores"]').value = info.textContent.match(/CPU: (\d+)/)?.[1] || '';
        form.querySelector('[name="memory_size"]').value = info.textContent.match(/内存: (\d+)/)?.[1] || '';
        form.querySelector('[name="disk_size"]').value = info.textContent.match(/磁盘: (\d+)/)?.[1] || '';
        form.querySelector('[name="description"]').value = info.textContent.match(/[^:]+$/)?.[0].trim() || '';
        
        // 修改模态框标题和保存按钮
        document.querySelector('#newAssetModal .modal-title').textContent = '编辑资产';
        const saveBtn = document.querySelector('#newAssetModal .btn-primary');
        saveBtn.textContent = '保存修改';
        saveBtn.onclick = () => updateAsset(assetId);
        
        // 显示模态框
        new bootstrap.Modal(document.getElementById('newAssetModal')).show();
    }
    
    function deleteAsset(assetId) {
        if (confirm('确定要删除这个资产吗？')) {
            fetch(`/api/assets/${assetId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.querySelector(`[data-asset-id="${assetId}"]`).remove();
                    showToast('success', '资产已删除');
                } else {
                    showToast('error', data.message);
                }
            })
            .catch(error => {
                showToast('error', '删除失败：' + error.message);
            });
        }
    }
    
    // 获取 CSRF token
    function getCsrfToken() {
        return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    }

    function saveAsset() {
        const form = document.getElementById('assetForm');
        const formData = new FormData(form);
        
        // 构建资产数据
        const data = {
            name: formData.get('name'),
            ip_address: formData.get('ip_address'),
            type: formData.get('type'),
            status: formData.get('status'),  // 添加状态
            specs: {
                os_type: formData.get('os_type'),
                os_version: formData.get('os_version'),
                cpu_cores: parseInt(formData.get('cpu_cores')) || 0,
                memory_size: parseInt(formData.get('memory_size')) || 0,
                disk_size: parseInt(formData.get('disk_size')) || 0,
                description: formData.get('description')
            }
        };

        // 发送请求
        fetch('/api/assets', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.getCsrfToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.showToast('success', '资产添加成功');
                bootstrap.Modal.getInstance(document.getElementById('newAssetModal')).hide();
                location.reload();
            } else {
                throw new Error(data.message || '保存失败');
            }
        })
        .catch(error => {
            window.showToast('error', error.message);
        });
    }
    
    function updateAsset(assetId) {
        const form = document.getElementById('newAssetForm');
        const formData = new FormData(form);
        
        // 构建请求数据
        const data = {
            name: formData.get('name'),
            ip_address: formData.get('ip_address'),
            type: formData.get('type'),
            os_type: formData.get('os_type'),
            os_version: formData.get('os_version'),
            cpu_cores: parseInt(formData.get('cpu_cores')) || null,
            memory_size: parseInt(formData.get('memory_size')) || null,
            disk_size: parseInt(formData.get('disk_size')) || null,
            description: formData.get('description')
        };
        
        // 发送请求
        fetch(`/api/assets/${assetId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                bootstrap.Modal.getInstance(document.getElementById('newAssetModal')).hide();
                location.reload();
            } else {
                showToast('error', data.message);
            }
        })
        .catch(error => {
            showToast('error', '更新失败：' + error.message);
        });
    }
    
    function showToast(type, message) {
        const toastContainer = document.getElementById('toastContainer') || createToastContainer();
        
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
        
        // 自动移除
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }
    
    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(container);
        return container;
    }
    
    function importAssets(input) {
        if (!input.files || !input.files[0]) return;
        
        const file = input.files[0];
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/api/assets/import', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showToast('success', data.message);
                if (data.errors && data.errors.length > 0) {
                    // 显示详细错误信息
                    const errorList = data.errors.join('\n');
                    alert('导入过程中出现以下错误:\n' + errorList);
                }
                location.reload();
            } else {
                showToast('error', data.message);
            }
        })
        .catch(error => {
            showToast('error', '导入失败：' + error.message);
        })
        .finally(() => {
            input.value = ''; // 清除文件选择
        });
    }

    let scanInProgress = false;
    let scanCancelled = false;
    let foundAssets = new Map(); // 存储发现的资产
    let autoScroll = true;
    let scanStats = {
        totalHosts: 0,
        scannedHosts: 0,
        onlineHosts: 0,
        servicesFound: 0
    };

    function updateScanStats() {
        document.getElementById('totalHosts').textContent = scanStats.totalHosts;
        document.getElementById('scannedHosts').textContent = scanStats.scannedHosts;
        document.getElementById('onlineHosts').textContent = scanStats.onlineHosts;
        document.getElementById('servicesFound').textContent = scanStats.servicesFound;
    }

    function addLogEntry(message, type = 'info') {
        const logsDiv = document.getElementById('scanLogs');
        const entry = document.createElement('div');
        entry.className = `log-entry text-${type} small`;
        
        // 根据消息类型选择图标
        const icon = type === 'info' ? 'bx-info-circle' :
                    type === 'success' ? 'bx-check-circle' :
                    type === 'warning' ? 'bx-error' :
                    type === 'error' ? 'bx-x-circle' : 'bx-dots-horizontal';
        
        entry.innerHTML = `
            <span class="text-muted">[${new Date().toLocaleTimeString()}]</span>
            <i class='bx ${icon}'></i>
            ${message}
        `;
        
        logsDiv.appendChild(entry);
        if (autoScroll) {
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // 如果是错误消息，显示toast提醒
        if (type === 'error') {
            window.showToast('error', message);
        }
    }

    function toggleAutoScroll() {
        autoScroll = !autoScroll;
        document.getElementById('autoScrollText').textContent = `自动滚动: ${autoScroll ? '开' : '关'}`;
    }

    function clearLogs() {
        document.getElementById('scanLogs').innerHTML = '';
    }

    function updateAssetCount() {
        document.getElementById('assetCount').textContent = foundAssets.size;
    }

    function startScan() {
        const networks = Array.from(document.querySelectorAll('#networkRanges input'))
            .map(input => input.value.trim())
            .filter(value => value);
        
        if (networks.length === 0) {
            window.showToast('error', '请至少输入一个网段');
            return;
        }
        
        // 重置界面
        document.getElementById('scanConfig').style.display = 'none';
        document.getElementById('scanProgress').style.display = 'block';
        document.getElementById('foundAssetsList').innerHTML = '';
        document.getElementById('scanLogs').innerHTML = '';
        foundAssets.clear();
        
        // 重置统计
        scanStats = {
            totalHosts: 0,
            scannedHosts: 0,
            onlineHosts: 0,
            servicesFound: 0
        };
        updateScanStats();
        
        // 重置进度条
        const progressBar = document.querySelector('.progress-bar');
        progressBar.style.width = '0%';
        progressBar.classList.remove('bg-danger');
        document.getElementById('progressPercent').textContent = '0%';
        
        scanInProgress = true;
        scanCancelled = false;
        
        // 开始扫描
        const eventSource = new EventSource(`/api/assets/scan?${new URLSearchParams({
            networks: networks.join(','),
            options: JSON.stringify({
                detect_os: true,
                scan_ports: true
            })
        })}`);
        
        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                console.log('Scan data:', data);  // 添加调试日志
                
                // 更新进度
                const progress = data.progress || 0;
                progressBar.style.width = `${progress}%`;
                document.getElementById('progressPercent').textContent = `${progress}%`;
                
                // 更新当前操作
                if (data.message) {
                    document.getElementById('currentOperation').textContent = data.message;
                }
                
                // 添加日志
                let logType = 'info';
                if (data.status === 'error') logType = 'danger';
                else if (data.status === 'warning') logType = 'warning';
                else if (data.status === 'success') logType = 'success';
                
                addLogEntry(data.message, logType);
                
                // 处理发现的资产
                if (data.found_asset) {
                    const asset = data.found_asset;
                    console.log('Found asset:', asset);  // 添加调试日志
                    
                    foundAssets.set(asset.ip, asset);
                    scanStats.onlineHosts++;
                    if (asset.open_ports) {
                        scanStats.servicesFound += asset.open_ports.length;
                    }
                    updateScanStats();
                    
                    // 添加到资产列表
                    const deviceType = determineDeviceType(asset);
                    const row = document.createElement('tr');
                    row.id = `asset-row-${asset.ip.replace(/\./g, '-')}`;
                    row.innerHTML = `
                        <td>${asset.ip}</td>
                        <td>${asset.hostname || '-'}</td>
                        <td>${deviceType}</td>
                        <td>${asset.os_type} ${asset.os_version}</td>
                        <td>${formatPorts(asset.open_ports)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="addFoundAsset('${asset.ip}')">
                                <i class='bx bx-plus'></i> 添加
                            </button>
                        </td>
                    `;
                    document.getElementById('foundAssetsList').appendChild(row);
                    document.getElementById('assetCount').textContent = foundAssets.size;
                }
                
                // 扫描完成
                if (progress === 100) {
                    eventSource.close();
                    scanInProgress = false;
                    addLogEntry('扫描完成', 'success');
                }
                
            } catch (error) {
                console.error('Error parsing scan data:', error);
                addLogEntry(`解析扫描数据出错: ${error.message}`, 'error');
            }
        };
        
        eventSource.onerror = function(error) {
            console.error('EventSource error:', error);
            eventSource.close();
            scanInProgress = false;
            addLogEntry('扫描连接出错，请检查网络连接', 'error');
            progressBar.classList.add('bg-danger');
        };
    }

    function addAllAssets() {
        foundAssets.forEach((asset, ip) => {
            addFoundAsset(ip);
        });
    }

    function determineDeviceType(asset) {
        // 根据开放端口和服务推测设备类型
        const ports = asset.open_ports || [];
        const services = ports.map(p => p.service.toLowerCase());
        
        if (services.includes('ssh') && services.includes('http')) {
            return '服务器';
        }
        if (services.includes('mysql')) {
            return '数据库服务器';
        }
        if (services.includes('redis') || services.includes('mongodb')) {
            return '缓存/NoSQL服务器';
        }
        if (services.includes('ftp')) {
            return 'FTP服务器';
        }
        if (services.includes('http') || services.includes('https')) {
            return 'Web服务器';
        }
        
        return '未知设备';
    }

    function formatPorts(ports) {
        if (!ports || ports.length === 0) return '无';
        return ports.map(p => `${p.port}(${p.service})`).join(', ');
    }

    function formatServices(services) {
        if (!services) return '-';
        return Object.entries(services)
            .filter(([_, info]) => info.status === 'online')
            .map(([name, info]) => `${name}${info.version ? ` (${info.version})` : ''}`)
            .join(', ');
    }

    function addFoundAsset(ip) {
        const asset = foundAssets.get(ip);
        if (!asset) return;

        fetch('/api/assets', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                name: `${determineDeviceType(asset)} (${asset.ip})`,
                ip_address: asset.ip,
                type: determineDeviceType(asset).toLowerCase().replace(/\s+.*$/, ''),
                status: 'online',
                os_type: asset.os_type,
                os_version: asset.os_version,
                open_ports: asset.open_ports,
                specs: {
                    hostname: asset.hostname,
                    services: asset.services
                }
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.showToast('success', '资产添加成功');
                // 禁用添加按钮
                const row = document.getElementById(`asset-row-${ip.replace(/\./g, '-')}`);
                if (row) {
                    const btn = row.querySelector('button');
                    btn.disabled = true;
                    btn.innerHTML = '<i class="bx bx-check"></i> 已添加';
                }
                // 刷新资产列表
                location.reload();
            } else {
                throw new Error(data.message || '添加失败');
            }
        })
        .catch(error => {
            window.showToast('error', error.message);
        });
    }

    function cancelScan() {
        if (scanInProgress) {
            scanCancelled = true;
            fetch('/api/assets/scan/cancel', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken()
                }
            });
        }
        bootstrap.Modal.getInstance(document.getElementById('scanProgressModal')).hide();
    }

    // 添加网段输入框
    function addNetworkRange() {
        const rangeDiv = document.createElement('div');
        rangeDiv.className = 'network-range mb-2';
        rangeDiv.innerHTML = `
            <div class="input-group">
                <input type="text" class="form-control bg-dark text-light" 
                       placeholder="例如：192.168.1.0/24">
                <button class="btn btn-outline-danger" type="button" onclick="removeNetworkRange(this)">
                    <i class='bx bx-trash'></i>
                </button>
            </div>
        `;
        document.getElementById('networkRanges').appendChild(rangeDiv);
    }

    // 移除网段输入框
    function removeNetworkRange(button) {
        const rangesDiv = document.getElementById('networkRanges');
        if (rangesDiv.children.length > 1) {
            button.closest('.network-range').remove();
        }
    }

    function checkAsset(assetId) {
        const resultModal = new bootstrap.Modal(document.getElementById('checkResultModal'));
        const resultDiv = document.getElementById('checkResult');
        
        resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p>正在检测中...</p></div>';
        resultModal.show();
        
        fetch(`/api/assets/check/${assetId}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                let html = '<div class="check-results">';
                
                // 显示基本连通性
                const ping = data.data.ping;
                html += `
                    <div class="mb-3">
                        <h6>基本连通性</h6>
                        <div class="alert ${ping.status === 'online' ? 'alert-success' : 'alert-danger'}">
                            状态: ${ping.status === 'online' ? '在线' : '离线'}
                            ${ping.response_time ? `<br>响应时间: ${ping.response_time}ms` : ''}
                        </div>
                    </div>
                `;
                
                // 显示开放端口
                if (data.data.ports && data.data.ports.length > 0) {
                    html += `
                        <div class="mb-3">
                            <h6>开放端口</h6>
                            <div class="table-responsive">
                                <table class="table table-dark table-sm">
                                    <thead>
                                        <tr>
                                            <th>端口</th>
                                            <th>服务</th>
                                            <th>版本</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.data.ports.map(port => `
                                            <tr>
                                                <td>${port.port}</td>
                                                <td>${port.service}</td>
                                                <td>${port.version || '-'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                }
                
                // 显示服务检测结果
                if (data.data.services) {
                    html += '<div class="mb-3"><h6>服务检测</h6>';
                    for (const [service, info] of Object.entries(data.data.services)) {
                        html += `
                            <div class="alert ${info.status === 'online' ? 'alert-success' : 'alert-danger'} mb-2">
                                <strong>${service.toUpperCase()}</strong><br>
                                状态: ${info.status === 'online' ? '在线' : '离线'}
                                ${info.version ? `<br>版本: ${info.version}` : ''}
                                ${info.response_time ? `<br>响应时间: ${info.response_time}ms` : ''}
                            </div>
                        `;
                    }
                    html += '</div>';
                }
                
                html += '</div>';
                resultDiv.innerHTML = html;
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
            }
        })
        .catch(error => {
            resultDiv.innerHTML = `<div class="alert alert-danger">检测出错: ${error.message}</div>`;
        });
    }
</script>
{% endblock %} 